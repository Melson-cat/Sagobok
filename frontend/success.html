<!-- success.html (minimalt) -->
<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tack!</title>
  <!-- Se CSS-fix nedan -->
  <link rel="stylesheet" href="./style.css">
  <style>
    body { font-family: system-ui, sans-serif; padding: 24px; max-width: 680px; margin: auto; }
    .hidden{display:none}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:#1f6feb;color:#fff}
  </style>
</head>
<body>
  <h1>Tack! ðŸŽ‰</h1>
  <p>Vi bekrÃ¤ftar betalningen och fÃ¶rbereder din nedladdningâ€¦</p>
  <p id="err" class="hidden" style="color:#b00020"></p>
  <p><button id="dlBtn" class="btn hidden">Ladda ner igen</button></p>

<script>
const API = "https://bokpilot-backend.sebastian-runell.workers.dev";
const CHECKOUT_DRAFT_KEY = "bp_checkout_draft_v1";

async function verifyPaid(session_id){
  const r = await fetch(`${API}/api/checkout/verify?session_id=${encodeURIComponent(session_id)}`);
  if (!r.ok) throw new Error("Kunde inte verifiera betalning");
  const j = await r.json();
  if (!j.paid) throw new Error("Betalningen Ã¤r inte markerad som betald Ã¤n");
  return j;
}

async function buildAndDownload(draft){
  const r = await fetch(`${API}/api/pdf`,{
    method:"POST",
    headers:{"content-type":"application/json"},
    body: JSON.stringify({
      story: draft.story,
      images: draft.images,
      mode: "final",             // skarp PDF
      trim: draft.trim || "square210",
      watermark_text: ""         // ingen watermark
    })
  });
  if(!r.ok) throw new Error(`PDF misslyckades (HTTP ${r.status})`);
  const blob = await r.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = (draft.story?.book?.title || "Sagobok") + ".pdf";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

async function init(){
  const params = new URLSearchParams(location.search);
  const sid = params.get("session_id");
  const errEl = document.getElementById("err");
  const dlBtn = document.getElementById("dlBtn");

  try {
    if(!sid) throw new Error("Saknar session_id");
    await verifyPaid(sid);

    const raw = localStorage.getItem(CHECKOUT_DRAFT_KEY);
    if(!raw) throw new Error("Hittar inte bokdata. Skapa boken igen och kontakta support vid problem.");
    const draft = JSON.parse(raw);

    // bygg & ladda ner
    await buildAndDownload(draft);

    // valfritt: spara â€œkvittoâ€ lokalt, sen rensa draft
    localStorage.removeItem(CHECKOUT_DRAFT_KEY);

    // visa â€œladda ner igenâ€-knapp (bygg frÃ¥n sparat utkast, hÃ¤r borttaget)
    dlBtn.classList.remove("hidden");
    dlBtn.onclick = ()=> buildAndDownload(draft);

  } catch(e){
    console.error(e);
    errEl.textContent = e.message || String(e);
    errEl.classList.remove("hidden");
  }
}
init();
</script>
</body>
</html>
