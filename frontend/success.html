<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Tack f√∂r ditt k√∂p! ‚Äì SagoStugan</title>
  <link rel="icon" href="images/pilot-logo.png">
  <link rel="stylesheet" href="./style.css">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    /* Sm√•, lokala f√∂rb√§ttringar utan att r√∂ra din globala CSS */
    .hidden { display: none !important; }
    .links a + a { margin-left: .5rem; }
    .retry-row { margin-top: 12px; display: flex; gap: 8px; align-items: center; }
    .status-inline { display: inline-flex; align-items: center; gap: 8px; }
    .pill { text-transform: capitalize; }
    .field input:invalid { outline: 2px solid #e66; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body data-theme="kids">
  <!-- Global Header -->
  <header class="site-header" role="banner">
    <a href="/index.html" class="brand" aria-label="SagoStugan startsida">
      <img src="images/pilot-logo.png" alt="SagoStugan" />
      <span>SagoStugan</span>
    </a>
    <nav class="main-nav" aria-label="Huvudmeny">
      <a href="/index.html" data-nav="home">Hem</a>
      <a href="/index.html#bookForm" data-nav="create">Skapa bok</a>
      <a href="/index.html#examples" data-nav="examples">Exempel</a>
      <a href="/index.html#about" data-nav="about">Om oss</a>
      <a href="/status.html" data-nav="status">Status</a>
    </nav>
    <button id="navToggle" class="hamburger" aria-label="Meny" aria-expanded="false" aria-controls="mobileMenu">‚ò∞</button>
  </header>
  <div class="mobile-menu" id="mobileMenu" aria-hidden="true">
    <nav>
      <a href="/index.html">Hem</a>
      <a href="/index.html#bookForm">Skapa bok</a>
      <a href="/index.html#examples">Exempel</a>
      <a href="/index.html#about">Om oss</a>
      <a href="/status.html">Status</a>
    </nav>
  </div>

  <main class="container">
    <section class="panel" aria-labelledby="thanksTitle">
      <h1 id="thanksTitle" style="margin:0 0 8px">Tack f√∂r ditt k√∂p! üéâ</h1>

      <p id="status" class="muted status-inline" aria-live="polite">Verifierar betalning‚Ä¶</p>
      <div class="spinner-lg" id="spinner" aria-hidden="true"></div>

      <div class="retry-row hidden" id="retryRow">
        <button id="btnRetry" class="btn btn-secondary" type="button">F√∂rs√∂k igen</button>
        <button id="btnBack" class="btn" type="button" onclick="location.href='/index.html'">Till startsidan</button>
        <span id="retryHint" class="muted"></span>
      </div>

      <div class="box hidden" id="orderBox" style="margin-top:12px">
        <div class="stack">
          <span class="pill" id="pillKind">‚Äî</span>
          <span>Order-ID: <strong id="orderId">‚Äî</strong></span>
          <span>Belopp: <strong id="amount">‚Äî</strong> <span id="currency"></span></span>
        </div>
      </div>

      <p id="statusText" class="muted" aria-live="polite"></p>
      <div class="links" id="downloadLinks"></div>

      <div id="errWrap" class="hidden" role="alert" aria-live="assertive" style="margin-top:8px">
        <p id="err" class="muted"></p>
      </div>

      <!-- PRINT FORM -->
      <form id="printForm" class="form-card hidden" novalidate>
        <h3>Leveransuppgifter f√∂r tryckt bok</h3>
        <p class="muted">Fyll i adress och namn f√∂r frakt.</p>

        <div class="form-row">
          <div class="field">
            <label for="firstName">F√∂rnamn</label>
            <input id="firstName" required autocomplete="given-name" />
          </div>
          <div class="field">
            <label for="lastName">Efternamn</label>
            <input id="lastName" required autocomplete="family-name" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="email">E-post</label>
            <input id="email" type="email" placeholder="namn@exempel.se" autocomplete="email" />
          </div>
          <div class="field">
            <label for="phone">Telefon</label>
            <input id="phone" type="tel" placeholder="0701234567" autocomplete="tel" />
          </div>
        </div>

        <div class="field">
          <label for="address1">Adressrad 1</label>
          <input id="address1" required autocomplete="address-line1" />
        </div>
        <div class="field">
          <label for="address2">Adressrad 2 (valfritt)</label>
          <input id="address2" autocomplete="address-line2" />
        </div>

        <div class="form-row">
          <div class="field">
            <label for="postCode">Postnummer</label>
            <input id="postCode" required inputmode="numeric" pattern="[0-9 ]{3,10}" autocomplete="postal-code" />
          </div>
          <div class="field">
            <label for="city">Ort</label>
            <input id="city" required autocomplete="address-level2" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label for="country">Land</label>
            <select id="country" autocomplete="country">
              <option value="SE" selected>Sverige (SE)</option>
              <option value="NO">Norge (NO)</option>
              <option value="FI">Finland (FI)</option>
              <option value="DK">Danmark (DK)</option>
              <option value="DE">Tyskland (DE)</option>
              <option value="US">USA (US)</option>
            </select>
          </div>
         <div class="field">
  <label>Frakt</label>
  <div id="shippingSummary" class="shipping-summary">
    Fraktpris: 87kr.
  </div>
  <p class="hint">
    Vi skickar alltid med standardfrakt (ca 4‚Äì6 dagar).
  </p>
</div>


        <div class="actions">
          <button class="btn btn-primary" id="btnSubmitPrint" type="submit">Skicka till tryck</button>
          <span class="muted" id="printHint" aria-live="polite"></span>
        </div>
      </form>
    </section>
  </main>

  <footer class="site-footer" role="contentinfo">
    <p>¬© 2025 SagoStugan</p>
  </footer>

  <script>
  // Header controller (delad)
  (function () {
    const toggle = document.getElementById("navToggle");
    const menu = document.getElementById("mobileMenu");
    if (toggle && menu) {
      const setOpen = (open) => {
        toggle.setAttribute("aria-expanded", String(open));
        menu.setAttribute("aria-hidden", String(!open));
        menu.classList.toggle("open", open);
      };
      setOpen(false);
      toggle.addEventListener("click", () => {
        const isOpen = toggle.getAttribute("aria-expanded") === "true";
        setOpen(!isOpen);
      });
      menu.addEventListener("click", (e) => {
        if (e.target && e.target.tagName === "A") setOpen(false);
      });
    }
  })();
  </script>

  <!-- Success-logik -->
 <script>
(() => {
  const BACKEND = "https://bokpilot-backend.sebastian-runell.workers.dev";

  /* -------------------------- DOM helpers -------------------------- */
  const $id  = (id) => document.getElementById(id);
  const qs   = (k, fb=null) => new URLSearchParams(location.search).get(k) ?? fb;
  const show = (el) => el && el.classList.remove("hidden");
  const hide = (el) => el && el.classList.add("hidden");
  const setText = (el, v) => { if (el) el.textContent = v ?? ""; };
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  const el = {
    status:   $id("status"),
    spinner:  $id("spinner"),
    retryRow: $id("retryRow"),
    btnRetry: $id("btnRetry"),
    retryHint:$id("retryHint"),
    box:      $id("orderBox"),
    pillKind: $id("pillKind"),
    orderId:  $id("orderId"),
    amount:   $id("amount"),
    currency: $id("currency"),
    statusText:$id("statusText"),
    errWrap:  $id("errWrap"),
    err:      $id("err"),
    links:    $id("downloadLinks"),
    form:     $id("printForm"),
    f: {
      firstName: $id("firstName"),
      lastName:  $id("lastName"),
      email:     $id("email"),
      phone:     $id("phone"),
      address1:  $id("address1"),
      address2:  $id("address2"),
      postCode:  $id("postCode"),
      city:      $id("city"),
      country:   $id("country"),
      shipMeth:  $id("shipmentMethod"),
      btn:       $id("btnSubmitPrint"),
      hint:      $id("printHint"),
    }
  };

  /* -------------------------- Net helpers -------------------------- */
  async function fetchJSON(url, init) {
    const r = await fetch(url, init);
    const ct = r.headers.get("content-type") || "";
    const isJSON = ct.includes("application/json");
    const body = isJSON ? await r.json() : await r.text();
    if (!r.ok || (isJSON && body && body.error)) {
      const msg = (isJSON && body && body.error) || `HTTP ${r.status}`;
      const err = new Error(msg);
      if (isJSON) err.details = body;
      throw err;
    }
    return isJSON ? body : { text: body };
  }

  const api = {
    verifySession: (sid) =>
      fetchJSON(`${BACKEND}/api/checkout/verify?session_id=${encodeURIComponent(sid)}`),
    mapOrderId: (sid) =>
      fetchJSON(`${BACKEND}/api/checkout/order-id?session_id=${encodeURIComponent(sid)}`),
    getOrder: (id) =>
      fetchJSON(`${BACKEND}/api/orders/status?id=${encodeURIComponent(id)}`),
        ensureSingleUrl: ({ story, images, mode, order_id, deliverable, trim }) =>
    fetchJSON(`${BACKEND}/api/pdf/single-url`, {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ story, images, mode, order_id, deliverable, trim })
    }),
    getShipMethods: (country) =>
      fetchJSON(`${BACKEND}/api/gelato/shipment-methods?country=${encodeURIComponent(country)}`),
    createGelato: (order_id, shipment, customer) =>
      fetchJSON(`${BACKEND}/api/gelato/create`, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ order_id, shipment, customer })
      }),
  };

  /* -------------------------- UI helpers --------------------------- */
  function setBanner(msg){ setText(el.status, msg); }
  function setSub(msg){ setText(el.statusText, msg); }
  function clearErr(){ if (el.err){ el.err.textContent=""; hide(el.errWrap); } }
  function showErr(msg){
    if (el.err){ el.err.textContent = String(msg || "Ett fel uppstod."); show(el.errWrap); }
  }
  function link(href, text){
    const a = document.createElement("a");
    a.href = href; a.target="_blank"; a.rel="noopener";
    a.className = "btn btn-secondary";
    a.textContent = text;
    return a;
  }

  function renderFiles(files){
    if (!el.links) return;
    el.links.innerHTML = "";

    // ‚úÖ En-fil f√∂rstahandsval
    if (files?.single_pdf_url) {
      el.links.appendChild(link(files.single_pdf_url, "Ladda ner boken (PDF)"));
      return;
    }

    // ‚¨áÔ∏è Fallback f√∂r √§ldre ordrar
    if (files?.print_url)    el.links.appendChild(link(files.print_url, "Ladda ner boken (PDF)"));
    if (files?.interior_url) el.links.appendChild(link(files.interior_url, "Ladda ner inlagan (PDF)"));
    if (files?.cover_url)    el.links.appendChild(link(files.cover_url, "Ladda ner omslaget (PDF)"));
  }

  /* ----------------------- Session + Order ------------------------- */
  function persistSessionId(sid){
    try{
      sessionStorage.setItem("bp:last_session_id", sid);
      localStorage.setItem("bp:last_session_id", sid);
    }catch{}
    const url = new URL(location.href);
    if (url.searchParams.get("session_id") !== sid){
      url.searchParams.set("session_id", sid);
      history.replaceState(null, "", url.toString());
    }
  }
  function loadSessionId(){
    return qs("session_id")
        || sessionStorage.getItem("bp:last_session_id")
        || localStorage.getItem("bp:last_session_id")
        || null;
  }
  function gelatoSubmittedKey(order_id){ return `bp:g:submitted:${order_id}`; }
  function markGelatoSubmitted(order_id, gelato_id){
    try { sessionStorage.setItem(gelatoSubmittedKey(order_id), gelato_id || "1"); }catch{}
  }
  function wasGelatoSubmitted(order_id){
    try { return !!sessionStorage.getItem(gelatoSubmittedKey(order_id)); }catch{ return false; }
  }

  /* ------------------------ Core helpers --------------------------- */
  async function pollWithBackoff(fn, {
    timeoutMs = 120000,
    baseDelay = 800,
    maxDelay = 4000,
    factor = 1.5,
    isDone = (val) => !!val
  } = {}) {
    const t0 = Date.now();
    let delay = baseDelay;
    while (Date.now() - t0 < timeoutMs) {
      const v = await fn().catch(() => null);
      if (isDone(v)) return v;
      await sleep(delay);
      delay = Math.min(maxDelay, Math.floor(delay * factor));
    }
    throw new Error("Timeout ‚Äì f√∂rs√∂ket tog f√∂r l√•ng tid. F√∂rs√∂k igen.");
  }

  async function ensurePaid(order_id){
    return pollWithBackoff(
      () => api.getOrder(order_id),
      { isDone: (o) => o && (o.status === "paid" || o.status === "ready") }
    );
  }

 // üîë Skapa & spara EN PDF om den inte redan finns
async function ensureSingle(order_id, deliverable){
  // H√§mta ev. existerande order
  let o = await api.getOrder(order_id);
  if (o?.files?.single_pdf_url) return o; // redan klart

  try {
    setBanner("Skapar din bok (PDF) ‚Ä¶");

    // Vi ber backend skapa / uppdatera r√§tt PDF
    await api.ensureSingleUrl({
      order_id,
      // l√•t backend anv√§nda KV/story, vi beh√∂ver inte skicka allting h√§r
      mode: (deliverable === "print") ? "print" : "preview",
      deliverable,
      // üîπ matchar din TRIMS-konfig
      trim: "square200"
    });

    // Liten paus, sedan h√§mta uppdaterad order
    await sleep(800);
    o = await api.getOrder(order_id);
  } catch (e){
    throw new Error(e?.message || "Misslyckades skapa enfilspdf.");
  }
  return o;
}


async function fillShipMethods(country) {
  try {
    // Visa tillf√§lligt meddelande (men det kommer √§nd√• d√∂ljas/disable:as)
    el.f.shipMeth.innerHTML = `<option disabled>H√§mtar frakt‚Ä¶</option>`;

    const data = await api.getShipMethods(country);
    const list = data?.shipmentMethods || [];

    el.f.shipMeth.innerHTML = "";

    if (!list.length) {
      // Inga metoder ‚Äì l√§mna tomt men logga
      el.f.shipMeth.innerHTML = `<option value="">Ingen fraktmetod hittades</option>`;
      el.f.shipMeth.disabled = true;
      if (el.f.shipSummary) {
        el.f.shipSummary.textContent = "Frakt: ok√§nd ‚Äì f√∂rs√∂k igen senare.";
      }
      return;
    }

    // 1) F√∂rs√∂k hitta "normal"
    let normal = list.find(
      (m) =>
        String(m.shipmentMethodUid || "").toLowerCase() === "normal" ||
        String(m.type || "").toLowerCase() === "normal"
    );

    // 2) Fallback: ta billigaste
    if (!normal) {
      normal = [...list].sort((a, b) => {
        const pa = Number(a.price || a.totalPrice || a.totalPriceInMinorUnits || 0);
        const pb = Number(b.price || b.totalPrice || b.totalPriceInMinorUnits || 0);
        return pa - pb;
      })[0];
    }

    // S√§tt ENDA alternativet i selecten
    const opt = document.createElement("option");
    opt.value = normal.shipmentMethodUid || "normal";
    opt.textContent = normal.displayName || normal.name || normal.type || "Standardfrakt";
    el.f.shipMeth.appendChild(opt);

    // L√•s ner selecten ‚Äì anv√§ndaren kan inte √§ndra
    el.f.shipMeth.disabled = true;

    // Visa sammanfattning i text (l√§gg till <p id="shipSummary">Frakt‚Ä¶</p> i HTML)
    if (el.f.shipSummary) {
      // f√∂rs√∂k plocka pris snyggt, annars h√•rdkoda "fr√•n 89 kr"
      let priceText = "fr√•n 89 kr";
      const rawPrice =
        normal.price || normal.totalPrice || normal.totalPriceInMinorUnits || null;

      if (rawPrice != null) {
        const val = Number(rawPrice);
        // Om Gelato skickar √∂ren (minor units), dela med 100
        const sek = val > 1000 ? Math.round(val / 100) : val;
        priceText = `${sek} kr`;
      }

      el.f.shipSummary.textContent =
        `Frakt: ${priceText} (standardleverans, ca 4‚Äì7 arbetsdagar).`;
    }
  } catch (e) {
    console.error("fillShipMethods error", e);
    el.f.shipMeth.innerHTML = `<option value="">Kunde inte h√§mta frakt</option>`;
    el.f.shipMeth.disabled = true;
    if (el.f.shipSummary) {
      el.f.shipSummary.textContent = "Frakt: kunde inte h√§mtas just nu.";
    }
  }
}



  function normalizePostcode(country, value){
    const v = (value || "").trim();
    if (country === "SE") {
      const digits = v.replace(/\D+/g,"");
      if (digits.length === 5) return digits.slice(0,3) + " " + digits.slice(3);
    }
    return v;
  }

  function wireForm(order_id, paidOrder){
  el.f.country.addEventListener("change", () => fillShipMethods(el.f.country.value));

  let submitting = false;
  el.form.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    if (submitting) return;
    clearErr();

    if (wasGelatoSubmitted(order_id)){
      hide(el.form);
      setBanner("Ordern √§r redan skickad till tryckpartnern ‚úî");
      return;
    }

    try{
      if (!el.form.checkValidity()) {
        el.form.reportValidity();
        return;
      }

      submitting = true;
      el.f.btn.disabled = true;
      setBanner("Skickar till tryck‚Ä¶");
      setText(el.f.hint, "Skickar ordern‚Ä¶");

      // ‚úÖ 1) SE TILL ATT ENFILSPDF FINNS (extra s√§kerhet)
      let ord = await api.getOrder(order_id);
      if (!ord?.files?.single_pdf_url || !ord.files.page_count) {
        // F√∂r tryckt bok ska vi alltid bygga i "print"-mode
        ord = await ensureSingle(order_id, "print");
      }

      // Om n√•got fortfarande √§r knas ‚Üí kasta tydligt fel
      if (!ord?.files?.single_pdf_url || !ord.files.page_count) {
        throw new Error("Kunde inte skapa tryckf√§rdig PDF f√∂r ordern (saknar single_pdf_url/page_count).");
      }

      // ‚úÖ 2) Bygg shipment + customer
      const shipment = {
        addressLine1: el.f.address1.value.trim(),
        addressLine2: el.f.address2.value.trim(),
        city:         el.f.city.value.trim(),
        postCode:     normalizePostcode(el.f.country.value, el.f.postCode.value),
        country:      el.f.country.value,
        state:        "",
        shipmentMethodUid: el.f.shipMeth.value || undefined,
      };
      const customer = {
        firstName: el.f.firstName.value.trim(),
        lastName:  el.f.lastName.value.trim(),
        email:     (el.f.email.value.trim() || paidOrder?.email || ""),
        phone:     el.f.phone.value.trim(),
      };

      if (!shipment.addressLine1 || !shipment.city || !shipment.postCode || !shipment.country){
        throw new Error("Fyll i adress, postnummer, ort och land.");
      }
      if (!customer.firstName || !customer.lastName){
        throw new Error("Fyll i f√∂r- och efternamn.");
      }

      // ‚úÖ 3) Skicka till Gelato ‚Äì nu med garanterad single_pdf_url + page_count
      const res = await api.createGelato(order_id, shipment, customer);
      const gelatoId = res?.gelato?.id || res?.gelato?.orderId || res?.gelato?.data?.id || null;
      markGelatoSubmitted(order_id, gelatoId);

      setBanner("Tryckorder skapad ‚úì");
      if (res?.gelato?.orderType === "draft" || res?.gelato?.status === "draft") {
        setSub("Test-order simulerad (GELATO_DRY_RUN=true). Inga verkliga kostnader uppstod.");
      } else {
        setSub("Ordern har skickats till tryckpartnern. Vi uppdaterar status l√∂pande.");
      }
      hide(el.form);

    } catch (e){
      el.f.btn.disabled = false;
      submitting = false;
      setText(el.f.hint, "");
      showErr(e?.message || "Kunde inte skapa tryckorder.");
      setBanner("Ett fel uppstod.");
      console.error("createGelato error:", e);
    }
  }, { once:false });
}


  /* --------------------------- Init ------------------------------- */
  async function init(){
    try{
      clearErr();
      show(el.spinner);
      hide(el.retryRow);
      setBanner("Verifierar betalning‚Ä¶");

      // 1) H√§mta + persist session_id
      let sid = loadSessionId();
      if (!sid){
        showErr("Saknar session_id i URL:en.");
        setSub("Om du nyss betalade, uppdatera sidan ‚Äì eller g√• tillbaka till kassan.");
        hide(el.spinner);
        show(el.retryRow);
        return;
      }
      persistSessionId(sid);

      // 2) session ‚Üí order_id (+ belopp)
      let order_id = qs("order_id") || null;
      let amount=null, currency="SEK";

      let v = null;
      try { v = await api.verifySession(sid); } catch {}
      try {
        if (!order_id) {
          const mapped = await api.mapOrderId(sid);
          order_id = mapped?.order_id || null;
        }
      } catch {}
      if (!order_id) throw new Error("Kunde inte koppla session till order.");

      amount   = v?.amount_total ?? null;
      currency = (v?.currency || "SEK").toUpperCase();

      // 3) V√§nta in 'paid'
      const paidOrder = await ensurePaid(order_id);

      // 4) Typ (printed/pdf). URL vinner ‚Üí annars KV/draft/kind ‚Üí default pdf
      const kind = (qs("kind") || paidOrder?.kind || paidOrder?.draft?.kind || "pdf").toLowerCase();

      // 5) deliverable mapping
      const deliverable = (kind === "printed") ? "print" : "digital";
      const mode = (deliverable === "print") ? "print" : "preview";

      // 6) Topprad
      show(el.box);
      setText(el.orderId, order_id);
      setText(el.pillKind, kind === "printed" ? "Tryckt bok" : "Digital PDF");
      setText(el.amount, amount != null ? (amount/100).toFixed(2) : "‚Äî");
      setText(el.currency, currency);

      // 7) S√§kerst√§ll EN fil (skapas vid behov) och rendera l√§nkar
      let o = await api.getOrder(order_id);
      if (!o?.files?.single_pdf_url) {
        o = await ensureSingle(order_id, deliverable);
      }
      renderFiles(o.files || {});
      hide(el.spinner);

      // 8) Produkt-branch
      if (kind !== "printed"){
        setBanner("Klart! Din PDF √§r redo.");
        setSub("Du kan ladda ner via l√§nken nedan. Kvitto skickas via Stripe.");
        hide(el.form);
        // Auto-√∂ppna en g√•ng per session
        if (o?.files?.single_pdf_url){
          const key = `bp:open:${o.files.single_pdf_url}`;
          if (!sessionStorage.getItem(key)){
            try { window.open(o.files.single_pdf_url, "_blank", "noopener"); } catch {}
            sessionStorage.setItem(key, "1");
          }
        }
        return;
      }

      // ---- Tryckt fl√∂de ----
      if (paidOrder?.email) el.f.email.value = paidOrder.email;
      await fillShipMethods(el.f.country.value);

      const alreadyGelato = !!o?.files?.gelato_order_id || wasGelatoSubmitted(order_id);
      if (alreadyGelato){
        hide(el.form);
        setBanner("Ordern √§r skickad till tryckpartnern ‚úî");
        setSub("Vi uppdaterar status l√∂pande.");
      } else {
        show(el.form);
        setBanner("Betalning bekr√§ftad! F√∂rbered tryck‚Ä¶");
        setSub("Fyll i leveransadress och v√§lj frakt f√∂r att skicka boken till tryck.");
        wireForm(order_id, paidOrder);
      }

      // Dev-diagnostik (frivilligt)
      console.table({
        order_id,
        session_id: sid,
        kind,
        deliverable,
        amount,
        currency,
        single_pdf_url: o?.files?.single_pdf_url || "(none)",
        gelato_order: o?.files?.gelato_order_id || "(none)"
      });

    } catch (e){
      hide(el.spinner);
      setBanner("Ett fel uppstod.");
      showErr(e?.message || "Ok√§nt fel.");
      show(el.retryRow);
      el.retryHint.textContent = "Om felet kvarst√•r: g√• till startsidan och f√∂rs√∂k igen fr√•n kassan.";
      console.error("success:init error:", e);
    }
  }

  // Retry-knapp
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", () => {
      el.btnRetry?.addEventListener("click", init);
      init();
    }, { once:true });
  } else {
    el.btnRetry?.addEventListener("click", init);
    init();
  }
})();
</script>

</body>
</html>
