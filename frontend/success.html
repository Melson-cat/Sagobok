<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tack f√∂r ditt k√∂p! ‚Äì BokPiloten</title>
  <link rel="icon" href="images/pilot-logo.png">
  <link rel="stylesheet" href="./style.css">

  <style>
    body {
      font-family: "Quicksand", system-ui, sans-serif;
      background: #fafafa;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 100vh;
      padding: 24px;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      color: #1f6feb;
    }
    p {
      font-size: 1rem;
      margin: 0.4rem 0;
    }
    .spinner {
      width: 36px;
      height: 36px;
      border: 4px solid #cce0ff;
      border-top-color: #1f6feb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .btn {
      display: inline-block;
      padding: 10px 18px;
      border-radius: 8px;
      background: #1f6feb;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 20px;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #1458c0;
    }
    .hidden {
      display: none;
    }
    #err {
      color: #b00020;
      font-weight: 600;
      margin-top: 16px;
    }
  </style>
</head>

<body>
  <h1>Tack f√∂r ditt k√∂p! üéâ</h1>
  <p id="status">Din betalning verifieras och boken byggs just nu...</p>
  <div class="spinner" id="spinner"></div>

  <p id="orderInfo" class="hidden">
    <strong>Order-ID:</strong> <span id="orderId">‚Äî</span><br>
    <strong>Belopp:</strong> <span id="amount">‚Äî</span> <span id="currency"></span>
  </p>

  <p id="statusText"></p>
<div id="downloadLinks" style="display:flex; gap:.5rem; flex-wrap:wrap"></div>

<script>
(() => {
  // ====== KONFIG ======
  const BACKEND = "https://bokpilot-backend.sebastian-runell.workers.dev";

  // ====== DOM HELPERS ======
  const $ = (id) => document.getElementById(id);
  const elStatus     = $("status");
  const elSpinner    = $("spinner");
  const elOrderInfo  = $("orderInfo");
  const elOrderId    = $("orderId");
  const elAmount     = $("amount");
  const elCurrency   = $("currency");
  const elErr        = $("err");
  const elStatusText = $("statusText");
  const elLinks      = $("downloadLinks");

  // HJ√ÑLPFUNKTIONER
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  async function fetchJSON(url, init) {
    const r = await fetch(url, init);
    const ct = r.headers.get("content-type") || "";
    const isJSON = ct.includes("application/json");
    const body = isJSON ? await r.json() : await r.text();
    if (!r.ok || (body && body.error)) {
      const msg = (body && body.error) || `HTTP ${r.status}`;
      throw new Error(msg);
    }
    return body;
  }

  function setHidden(el, hidden) {
    if (!el) return;
    hidden ? el.classList.add("hidden") : el.classList.remove("hidden");
  }

  function makeLink(href, text) {
    const a = document.createElement("a");
    a.href = href;
    a.target = "_blank";
    a.rel = "noopener";
    a.className = "btn";
    a.textContent = text;
    return a;
  }

  async function verifySession(session_id) {
    return fetchJSON(`${BACKEND}/api/checkout/verify?session_id=${encodeURIComponent(session_id)}`);
    // -> { paid:boolean, order_id:string|null, amount_total:number|null, currency:string|null }
  }

  async function getOrderIdFromSession(session_id) {
    const j = await fetchJSON(`${BACKEND}/api/checkout/order-id?session_id=${encodeURIComponent(session_id)}`);
    return j.order_id || null;
  }

  async function getOrder(order_id) {
    return fetchJSON(`${BACKEND}/api/orders/status?id=${encodeURIComponent(order_id)}`);
    // -> { id, status, ... , files?: {interior_url, cover_url} }
  }

  async function waitForPaid(order_id, timeoutMs = 120000, pollMs = 1500) {
    const start = Date.now();
    while (Date.now() - start < timeoutMs) {
      try {
        const o = await getOrder(order_id);
        if (o?.status === "paid" || o?.status === "ready") return o?.status;
      } catch (_) {}
      await sleep(pollMs);
    }
    throw new Error("Betalningen √§r √§nnu inte bekr√§ftad. Uppdatera sidan om en liten stund.");
  }

  async function buildAndAttach(order_id) {
    return fetchJSON(`${BACKEND}/api/pdf/build-and-attach`, {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify({ order_id })
    });
    // -> { ok:true } och KV uppdateras med files{interior_url, cover_url}
  }

  function renderLinks(files) {
    if (!elLinks) return;
    elLinks.innerHTML = "";
    if (files?.interior_url) elLinks.appendChild(makeLink(files.interior_url, "Ladda ner inlagan (PDF)"));
    if (files?.cover_url)    elLinks.appendChild(makeLink(files.cover_url, "Ladda ner omslaget (PDF)"));
  }

  async function init() {
    try {
      // 1) session_id i URL
      const sid = new URLSearchParams(location.search).get("session_id");
      if (!sid) throw new Error("Saknar session_id i URL:en.");

      setHidden(elErr, true);
      elStatus.textContent = "Verifierar betalning‚Ä¶";
      setHidden(elSpinner, false);

      // 2) F√∂rs√∂k h√§mta verifiering + order-id + belopp
      let order_id = null, amount = null, currency = null;
      try {
        const v = await verifySession(sid);
        order_id = v.order_id || order_id;
        amount   = v.amount_total ?? null;
        currency = v.currency     ?? null;
      } catch {
        // Fallback: mappa session -> order
        order_id = await getOrderIdFromSession(sid);
      }
      if (!order_id) throw new Error("Kunde inte koppla session till order.");

      // 3) Visa orderinfo (om belopp k√§ndes av)
      setHidden(elOrderInfo, false);
      elOrderId.textContent = order_id;
      if (amount != null)   elAmount.textContent   = (amount/100).toFixed(2);
      if (currency)         elCurrency.textContent = String(currency).toUpperCase();

      // 4) V√§nta tills webhook markerat ordern som paid/ready
      await waitForPaid(order_id);
      elStatus.textContent = "Betalning bekr√§ftad! Skapar och laddar upp dina PDF:er‚Ä¶";

      // 5) H√§mta order ‚Äì bygg om filer saknas ‚Äì h√§mta igen
      let ord = await getOrder(order_id);
      const hasInt = !!ord?.files?.interior_url;
      const hasCov = !!ord?.files?.cover_url;

      if (!hasInt || !hasCov) {
        await buildAndAttach(order_id);
        // kort delay f√∂r att KV ska s√§kert hinna uppdateras
        await sleep(500);
        ord = await getOrder(order_id);
      }

      // 6) Rendera l√§nkar + auto√∂ppna inlaga (kan blockas av popup-policy)
      renderLinks(ord.files);
      setHidden(elSpinner, true);
      elStatus.textContent = "Klart! Dina filer √§r redo.";
      if (elStatusText) elStatusText.textContent = "Du kan ladda ner igen via l√§nkarna nedan.";

      if (ord?.files?.interior_url) {
        try { window.open(ord.files.interior_url, "_blank", "noopener"); } catch {}
      }

    } catch (e) {
      console.error(e);
      setHidden(elSpinner, true);
      elStatus.textContent = "Ett fel uppstod.";
      if (elErr) {
        elErr.textContent = e?.message || String(e);
        setHidden(elErr, false);
      }
    }
  }

  // K√∂r n√§r DOM √§r redo
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init, { once: true });
  } else {
    init();
  }
})();
</script>

</body>
</html>
