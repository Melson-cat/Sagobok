<script>
const API = "https://bokpilot-backend.sebastian-runell.workers.dev";

async function getOrderIdFromSession(session_id){
  const r = await fetch(`${API}/api/checkout/order-id?session_id=${encodeURIComponent(session_id)}`);
  if (!r.ok) throw new Error("Kunde inte hämta order-id");
  const j = await r.json();
  return j.order_id || null;
}
async function getStatus(order_id){
  const r = await fetch(`${API}/api/orders/${encodeURIComponent(order_id)}/status`);
  if (!r.ok) throw new Error("order-status misslyckades");
  return await r.json(); // { order_id, status, updated_at }
}

async function waitForPaid(order_id, timeoutMs = 90000){
  const t0 = Date.now();
  while (Date.now() - t0 < timeoutMs) {
    const s = await getStatus(order_id);
    if (s.status === "paid" || s.status === "ready") return s.status;
    await new Promise(res => setTimeout(res, 1500));
  }
  throw new Error("Betalningen är inte bekräftad ännu. Uppdatera sidan om en stund.");
}

async function download(order_id){
  // Triggar servern att bygga & streama PDF (om ej redan klar)
  const url = `${API}/api/orders/${encodeURIComponent(order_id)}/download`;
  // Öppna i ny flik för att inte tappa sidan
  window.open(url, "_blank");
}

async function init(){
  const params = new URLSearchParams(location.search);
  let order_id = params.get("order_id");
  const session_id = params.get("session_id");

  const errEl = document.getElementById("err");
  const dlBtn = document.getElementById("dlBtn");

  try {
    if (!session_id) throw new Error("Saknar session_id i URL:en");

    // Om order_id saknas (t.ex. om Stripe inte returnerade), hämta via KV-mappningen
    if (!order_id) order_id = await getOrderIdFromSession(session_id);
    if (!order_id) throw new Error("Kunde inte slå upp order (order_id saknas)");

    // Vänta tills webbhooken satt status=paid, eller bygg ändå när status blir paid
    await waitForPaid(order_id);

    // Ladda ner serverstyrt (PDF byggs om det behövs)
    await download(order_id);

    // “ladda ner igen”
    dlBtn.classList.remove("hidden");
    dlBtn.onclick = () => download(order_id);

  } catch(e){
    console.error(e);
    errEl.textContent = e.message || String(e);
    errEl.classList.remove("hidden");
  }
}
init();
</script>
