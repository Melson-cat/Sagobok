<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tack f√∂r ditt k√∂p!</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body class="no-lock">
  <div class="container">
    <div class="panel">
      <h1>Tack! üéâ</h1>
      <p>Vi bekr√§ftar betalningen och f√∂rbereder din nedladdning‚Ä¶</p>
      <p id="msg" class="preview-note"></p>
      <div class="actions">
        <a id="dlLink" class="btn btn-primary" href="#" target="_blank" style="display:none">√ñppna din PDF</a>
        <a class="btn btn-secondary" href="./">Tillbaka till startsidan</a>
      </div>
    </div>
  </div>

  <script>
    const API = "https://bokpilot-backend.sebastian-runell.workers.dev";

    (async function init(){
      const p = new URLSearchParams(location.search);
      const sid = p.get("session_id");
      const msg = document.getElementById("msg");
      const dl  = document.getElementById("dlLink");

      if (!sid) {
        msg.textContent = "Saknar session_id ‚Äì kontakta support s√• hj√§lper vi dig.";
        return;
      }

      try {
        // 1) verifiera betalning
        const vr = await fetch(`${API}/api/checkout/verify?session_id=${encodeURIComponent(sid)}`);
        const vj = await vr.json().catch(()=> ({}));
        if (!vr.ok || !vj.paid) throw new Error("K√∂pet √§r inte bekr√§ftat √§nnu.");

        msg.textContent = "Betalningen √§r godk√§nd. Din PDF genereras nu‚Ä¶";

        // 2) h√§mta payload (sparad f√∂re redirect)
        const raw = localStorage.getItem("bp_checkout_payload");
        if (!raw) throw new Error("Hittar inte bokdata. Skapa boken igen och kontakta support vid problem.");
        const payload = JSON.parse(raw);

        // 3) bygg PDF via backend
        const pdfRes = await fetch(`${API}/api/pdf`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!pdfRes.ok) {
          const t = await pdfRes.text().catch(()=> "");
          throw new Error(`PDF misslyckades (HTTP ${pdfRes.status}). ${t}`);
        }

        const blob = await pdfRes.blob();
        const url = URL.createObjectURL(blob);
        dl.href = url;
        dl.style.display = "inline-flex";
        dl.click(); // auto-√∂ppna

        msg.textContent = "Klart! Din PDF har √∂ppnats i en ny flik. Du kan √§ven spara l√§nken ovan.";
        // valfritt: rensa payload (eller spara i 72h enligt din policy)
        // localStorage.removeItem("bp_checkout_payload");
      } catch (e) {
        msg.textContent = e?.message || "N√•got gick fel efter betalning. Kontakta support.";
        console.error(e);
      }
    })();
  </script>
</body>
</html>
