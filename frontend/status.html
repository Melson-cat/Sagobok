<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>BokPiloten â€“ Orderstatus</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --ink:#0f172a; --muted:#64748b; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --brand:#5b4ad9; --bg:#0b1020; --card:#121833; --chip:#1b2447;
    }
    body{margin:0;background:linear-gradient(180deg,#0a0f1f,#0f1630);color:#e6e9f2;font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:#c3c9ff;text-decoration:none}
    .container{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:rgba(255,255,255,.04);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:800px){.row{grid-template-columns:1fr}}
    .kvs{display:grid;grid-template-columns:160px 1fr;gap:8px 16px;margin-top:8px}
    .kvs div:nth-child(odd){color:#aab1c5}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#1b2447;border:1px solid rgba(255,255,255,.08);font-size:13px}
    .badge.ok{background:rgba(22,163,74,.15);border-color:rgba(22,163,74,.3)}
    .badge.warn{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.35)}
    .badge.bad{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .muted{color:#aab1c5}
    .progress{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 0}
    .step{padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#101736}
    .step.active{outline:2px solid #5b4ad9}
    .small{font-size:13px;color:#aab1c5}
    .spacer{height:12px}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#202a55;color:#fff}
    header{position:sticky;top:0;background:rgba(10,15,31,.7);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.08);z-index:10}
    nav{max-width:960px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center}
    nav .brand{font-weight:700;letter-spacing:.2px}
    nav a{padding:6px 10px;border-radius:8px}
    nav a.active{background:rgba(91,74,217,.2);border:1px solid rgba(91,74,217,.5)}
  </style>
</head>
<body>
  <!-- Global Header mount -->
  <header id="globalHeader"></header>

  <div class="container">
    <h1>Orderstatus</h1>
    <div class="small">FÃ¶lj tryck och leverans i realtid.</div>
    <div class="spacer"></div>

    <div class="card" id="statusCard">
      <div id="statusTop">
        <div class="badge warn" id="badge">Laddar statusâ€¦</div>
        <div class="small mono" id="orderHint"></div>
      </div>

      <div class="spacer"></div>

      <div class="row">
        <div>
          <h3>Ã–versikt</h3>
          <div class="kvs">
            <div>Order-ID</div><div class="mono" id="k_orderId">â€“</div>
            <div>Gelato Order</div><div class="mono" id="k_gelatoId">â€“</div>
            <div>Status</div><div id="k_status">â€“</div>
            <div>Sidor</div><div id="k_pages">â€“</div>
            <div>Produkt</div><div id="k_product">â€“</div>
          </div>

          <div class="spacer"></div>
          <h3>FÃ¶rlopp</h3>
          <div class="progress" id="progress"></div>
        </div>

        <div>
          <h3>Leveransadress</h3>
          <div class="kvs" id="addr">
            <div>Namn</div><div id="a_name">â€“</div>
            <div>E-post</div><div id="a_email">â€“</div>
            <div>Telefon</div><div id="a_phone">â€“</div>
            <div>Adress</div><div id="a_line1">â€“</div>
            <div>Stad / Postnr</div><div id="a_cityzip">â€“</div>
            <div>Land</div><div id="a_country">â€“</div>
          </div>

          <div class="spacer"></div>
          <a class="btn" id="btnRefresh" href="#">Uppdatera nu</a>
        </div>
      </div>

      <div class="spacer"></div>
      <details>
        <summary>Teknisk rÃ¥data</summary>
        <pre class="mono small" id="raw" style="white-space:pre-wrap;"></pre>
      </details>
    </div>
  </div>

  <script>
    // ===== Global header loader (Ã¥teranvÃ¤nds pÃ¥ alla sidor) =====
    async function loadGlobalHeader(activePath = location.pathname) {
      const mount = document.getElementById("globalHeader");
      if (!mount) return;
      const html = `
        <nav>
          <div class="brand">ðŸ“š BokPiloten</div>
          <a href="/index.html" class="${activePath.endsWith("index.html") ? "active": ""}">Hem</a>
          <a href="/success.html" class="${activePath.endsWith("success.html") ? "active": ""}">Tack</a>
          <a href="/status.html" class="${activePath.endsWith("status.html") ? "active": ""}">Status</a>
        </nav>
      `;
      mount.innerHTML = html;
    }
    loadGlobalHeader();

    // ===== Status-page logic =====
    const API_BASE = "https://bokpilot-backend.sebastian-runell.workers.dev";

    function getOrderId() {
      const url = new URL(location.href);
      return url.searchParams.get("order_id") || localStorage.getItem("bp_last_order_id") || "";
    }

    function statusToSteps(s) {
      // Mappa Gelato-status till en enkel funnel
      const k = String(s || "").toLowerCase();
      const steps = [
        { key:"created", label:"Skapad" },
        { key:"pending", label:"VÃ¤ntar/Valideras" },
        { key:"in_production", label:"I produktion" },
        { key:"shipped", label:"Skickad" },
        { key:"delivered", label:"Levererad" }
      ];
      // Heuristik
      let active = 0;
      if (["created","pending"].includes(k)) active = 1;
      if (k.includes("production") || k === "printed") active = 2;
      if (k.includes("ship")) active = 3;
      if (k.includes("deliver")) active = 4;
      return { steps, activeIndex: active };
    }

    function setBadge(status) {
      const b = document.getElementById("badge");
      const k = String(status || "").toLowerCase();
      b.classList.remove("ok","warn","bad");
      let text = k || "unknown";
      if (k === "pending" || k === "created") { b.classList.add("warn"); text = "VÃ¤ntar/valideras"; }
      else if (k.includes("production") || k === "printed") { b.classList.add("ok"); text = "I produktion"; }
      else if (k.includes("ship")) { b.classList.add("ok"); text = "Skickad"; }
      else if (k.includes("deliver")) { b.classList.add("ok"); text = "Levererad"; }
      else { b.classList.add("warn"); }
      b.textContent = `Status: ${text}`;
    }

    function renderProgress(status) {
      const { steps, activeIndex } = statusToSteps(status);
      const el = document.getElementById("progress");
      el.innerHTML = steps.map((s, i) =>
        `<div class="step ${i<=activeIndex ? "active": ""}">${s.label}</div>`
      ).join("");
    }

    async function fetchStatus(orderId) {
      const u = `${API_BASE}/api/gelato/status?order_id=${encodeURIComponent(orderId)}`;
      const r = await fetch(u);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    async function refresh() {
      const orderId = getOrderId();
      const hint = document.getElementById("orderHint");
      hint.textContent = orderId ? `(order_id=${orderId})` : "(ingen order_id hittades)";
      if (!orderId) return;

      try {
        const data = await fetchStatus(orderId);
        const g = data.gelato || {};
        const d = data.derived || {};
        const ord = data.order || {};

        // Ã–versikt
        document.getElementById("k_orderId").textContent = ord.id || "â€“";
        document.getElementById("k_gelatoId").textContent = g.id || g.orderId || "â€“";
        document.getElementById("k_status").textContent = (d.status || "unknown");
        document.getElementById("k_pages").textContent = d.pageCount ?? "â€“";
        document.getElementById("k_product").textContent = d.productUid || "â€“";

        // Badge + progress
        setBadge(d.status || g.fulfillmentStatus || g.status);
        renderProgress(d.status || g.fulfillmentStatus || g.status);

        // Adress
        const a = d.shippingAddress || {};
        document.getElementById("a_name").textContent = [a.firstName, a.lastName].filter(Boolean).join(" ") || "â€“";
        document.getElementById("a_email").textContent = a.email || "â€“";
        document.getElementById("a_phone").textContent = a.phone || "â€“";
        document.getElementById("a_line1").textContent = [a.addressLine1, a.addressLine2].filter(Boolean).join(", ") || "â€“";
        document.getElementById("a_cityzip").textContent = [a.city, a.postCode].filter(Boolean).join(" ") || "â€“";
        document.getElementById("a_country").textContent = a.country || "â€“";

        // RÃ¥data
        document.getElementById("raw").textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById("badge").classList.remove("ok","warn"); 
        document.getElementById("badge").classList.add("bad");
        document.getElementById("badge").textContent = "Kunde inte hÃ¤mta status";
        console.error(e);
      }
    }

    document.getElementById("btnRefresh").addEventListener("click", (e) => {
      e.preventDefault();
      refresh();
    });

    // Init + polling
    refresh();
    setInterval(refresh, 20000);
  </script>
</body>
</html>
