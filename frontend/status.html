<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orderstatus â€“ SagoStugan</title>
  <link rel="icon" href="images/pilot-logo.png">
  <link rel="stylesheet" href="./style.css">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body data-theme="kids">
  <!-- Global Header -->
  <header class="site-header" role="banner">
    <a href="/index.html" class="brand" aria-label="SagoStugan startsida">
      <img src="images/pilot-logo.png" alt="SagoStugan" />
      <span>SagoStugan</span>
    </a>
    <nav class="main-nav" aria-label="Huvudmeny">
      <a href="/index.html" data-nav="home">Hem</a>
      <a href="/index.html#bookForm" data-nav="create">Skapa bok</a>
      <a href="/index.html#examples" data-nav="examples">Exempel</a>
      <a href="/index.html#about" data-nav="about">Om oss</a>
      <a href="/status.html" data-nav="status" class="active">Status</a>
    </nav>
    <button id="navToggle" class="hamburger" aria-label="Meny" aria-expanded="false" aria-controls="mobileMenu">â˜°</button>
  </header>

  <div class="mobile-menu" id="mobileMenu" aria-hidden="true">
    <nav>
      <a href="/index.html">Hem</a>
      <a href="/index.html#bookForm">Skapa bok</a>
      <a href="/index.html#examples">Exempel</a>
      <a href="/index.html#about">Om oss</a>
      <a href="/status.html">Status</a>
    </nav>
  </div>

  <main class="container">
    <section class="panel" aria-labelledby="statusTitle">
      <h1 id="statusTitle" style="margin:0 0 8px">Orderstatus</h1>
      <div id="statusBar" class="status-bar" aria-live="polite">
        Ange ditt order-ID fÃ¶r att se status pÃ¥ din bok.
      </div>

      <!-- Endast Order-ID -->
      <form id="statusForm" class="form-card" style="margin-top:12px">
        <div class="form-row">
          <div class="field">
            <label for="orderIdInput">Order-ID</label>
            <input id="orderIdInput" placeholder="t.ex. 996a9557-..." />
            <p class="hint">
              Order-ID hittar du i bekrÃ¤ftelsemejlet frÃ¥n Sagostugan/SagoStugan.
            </p>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="btn btn-primary">Visa status</button>
        </div>
      </form>

      <!-- Resultatkort -->
      <div id="orderBox" class="box hidden" style="margin-top:16px">
        <div class="order-status-header">
          <div class="order-status-meta">
            <span class="pill" id="pillKind">â€”</span>
            <span>Order-ID: <strong id="orderId">â€”</strong></span>
            <span>Status: <strong id="orderState">â€”</strong></span>
          </div>
          <div class="order-status-time">
            <small id="lastUpdated" class="muted">â€”</small>
          </div>
        </div>

        <div class="order-status-body">
          <div class="order-cover-thumb">
            <!-- miniomslag -->
            <img id="coverThumb" alt="Omslag fÃ¶r din bok" class="hidden"
                 style="max-width:120px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.15);" />
          </div>
          <div class="order-book-info">
            <h2 id="bookTitle" style="margin:0 0 6px;font-size:1.1rem;">â€”</h2>
            <p id="bookInfo" class="muted" style="margin:0 0 8px;font-size:0.9rem;">
              NÃ¤r status Ã¤ndras hos tryckeriet uppdateras den hÃ¤r automatiskt nÃ¤r du laddar om sidan.
            </p>
            <div class="links" id="downloadLinks"></div>
          </div>
        </div>
      </div>

      <div class="spinner-lg hidden" id="spinner" aria-hidden="true"></div>
      <p id="err" class="muted hidden"></p>
    </section>
  </main>

  <footer class="site-footer" role="contentinfo">
    <p>Â© 2025 SagoStugan</p>
  </footer>

  <!-- Header controller (delad) -->
  <script>
  (function () {
    const toggle = document.getElementById("navToggle");
    const menu = document.getElementById("mobileMenu");
    if (!toggle || !menu) return;

    const setOpen = (open) => {
      toggle.setAttribute("aria-expanded", String(open));
      menu.setAttribute("aria-hidden", String(!open));
      menu.classList.toggle("open", open);
    };

    setOpen(false);

    toggle.addEventListener("click", () => {
      const isOpen = toggle.getAttribute("aria-expanded") === "true";
      setOpen(!isOpen);
    });

    menu.addEventListener("click", (e) => {
      if (e.target && e.target.tagName === "A") setOpen(false);
    });
  })();
  </script>

  <!-- Status-logik -->
  <script>
  (function () {
    const BACKEND = "https://bokpilot-backend.sebastian-runell.workers.dev";
    const $ = (id) => document.getElementById(id);
    const show = (el) => el && el.classList.remove("hidden");
    const hide = (el) => el && el.classList.add("hidden");
    const setText = (el, v) => { if (el) el.textContent = v ?? ""; };

    const el = {
      form: $("statusForm"),
      orderInput: $("orderIdInput"),
      bar: $("statusBar"),
      box: $("orderBox"),
      pillKind: $("pillKind"),
      orderId: $("orderId"),
      orderState: $("orderState"),
      lastUpdated: $("lastUpdated"),
      links: $("downloadLinks"),
      spinner: $("spinner"),
      err: $("err"),
      coverThumb: $("coverThumb"),
      bookTitle: $("bookTitle"),
      bookInfo: $("bookInfo"),
    };

    async function fetchJSON(url) {
      const r = await fetch(url);
      const ct = r.headers.get("content-type") || "";
      const isJSON = ct.includes("application/json");
      const body = isJSON ? await r.json() : await r.text();
      if (!r.ok || (isJSON && body && body.error)) {
        const msg = (isJSON && body && body.error) || `HTTP ${r.status}`;
        throw new Error(msg);
      }
      return isJSON ? body : { text: body };
    }

    const getOrder = (id) =>
      fetchJSON(`${BACKEND}/api/orders/status?id=${encodeURIComponent(id)}`);

    function renderFiles(files) {
      el.links.innerHTML = "";

      if (!files) return;

      // Full print-PDF (om du behÃ¥ller det)
      if (files.print_url) {
        const a = document.createElement("a");
        a.className = "btn";
        a.href = files.print_url;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = "Ladda ner boken (PDF)";
        el.links.appendChild(a);
        return; // om du vill att denna ersÃ¤tter inlaga/cover-lÃ¤nkarna
      }

      if (files.interior_url) {
        const a = document.createElement("a");
        a.className = "btn";
        a.href = files.interior_url;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = "Ladda ner inlagan (PDF)";
        el.links.appendChild(a);
      }

      if (files.cover_url) {
        const a = document.createElement("a");
        a.className = "btn";
        a.href = files.cover_url;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = "Ladda ner omslaget (PDF)";
        el.links.appendChild(a);
      }
    }

    function setBar(msg) { setText(el.bar, msg); }
    function showErr(msg) { setText(el.err, msg); show(el.err); }
    function clearErr() { setText(el.err, ""); hide(el.err); }

    // ðŸ” Huvudrendering av orderstatus
    function renderOrder(order, orderId) {
      show(el.box);

      setText(el.orderId, orderId);

      // status: fÃ¶rsÃ¶k anvÃ¤nda Gelatos/leverantÃ¶rens status direkt
      const statusRaw =
        order?.provider_status ||
        order?.gelato_status ||
        order?.status ||
        "okÃ¤nd";

      setText(el.orderState, statusRaw);

      // Typ av order
      const kind = (order?.kind || order?.draft?.kind || "pdf");
      const isPrinted = kind === "printed" || kind === "print";
      setText(el.pillKind, isPrinted ? "Tryckt bok" : "Digital PDF");

      // Titel + liten text
      const title =
        order?.book?.title ||
        order?.story?.book?.title ||
        "Din bok";

      setText(el.bookTitle, title);

      // HÃ¤r kan du lÃ¤gga in mer detaljer om du bÃ¶rjar returnera dem frÃ¥n backend
      const pages = order?.book?.pages ?? order?.story?.book?.pages;
      const pageCount = Array.isArray(pages) ? pages.length : null;
      const statusBlurb = isPrinted
        ? "Statusen speglar vad tryckeriet rapporterar (t.ex. paid, printing, shipped)."
        : "FÃ¶r digitala bÃ¶cker kan du ladda ner din PDF direkt hÃ¤r nedan.";

      setText(
        el.bookInfo,
        pageCount
          ? `${pageCount} inlagesidor. ${statusBlurb}`
          : statusBlurb
      );

      // Thumb fÃ¶r omslag â€“ backend bÃ¶r returnera antingen:
      //   order.book.cover_thumb_url
      //   eller order.cover_thumb_url
      const thumbUrl =
        order?.book?.cover_thumb_url ||
        order?.cover_thumb_url ||
        null;

      if (thumbUrl) {
        el.coverThumb.src = thumbUrl;
        show(el.coverThumb);
      } else {
        el.coverThumb.src = "";
        hide(el.coverThumb);
      }

      renderFiles(order.files || {});
      const now = new Date();
      setText(
        el.lastUpdated,
        `Senast uppdaterad: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`
      );
      setBar("Status hÃ¤mtad. Ladda om sidan senare om du vill se nÃ¤sta steg.");
    }

    async function loadStatus(orderId) {
      clearErr();
      show(el.spinner);
      try {
        const o = await getOrder(orderId);
        renderOrder(o, orderId);
      } catch (e) {
        showErr(e?.message || "Kunde inte hÃ¤mta order.");
        hide(el.box);
      } finally {
        hide(el.spinner);
      }
    }

    // Om ?id= finns i URL: auto-ladda
    (async () => {
      try {
        const url = new URL(location.href);
        const id = url.searchParams.get("id");
        if (id) {
          el.orderInput.value = id;
          await loadStatus(id);
        }
      } catch {
        // ignore
      }
    })();

    // Submit: endast order-id
    el.form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const id = el.orderInput.value.trim();
      if (!id) {
        showErr("Ange ett order-ID.");
        return;
      }
      await loadStatus(id);
      // Uppdatera URL sÃ¥ man kan dela/Ã¥terkomma
      try {
        history.replaceState({}, "", `?id=${encodeURIComponent(id)}`);
      } catch {
        // no-op
      }
    });
  })();
  </script>
</body>
</html>
