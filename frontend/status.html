<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orderstatus â€“ SagoStugan</title>
  <link rel="icon" href="images/pilot-logo.png">
  <link rel="stylesheet" href="./style.css">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    .hidden { display:none!important; }

    /* Matcha success-panelens stil */
    .status-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      padding: 32px 26px 38px;
      max-width: 820px;
      margin: 0 auto;
    }

    .status-panel h1 { font-size: 1.9rem; margin-bottom: 8px; }
    .status-panel .muted { color: var(--muted); }

    .spinner-lg {
      margin-top: 8px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 4px solid rgba(0,0,0,.08);
      border-top-color: var(--brand);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .order-box {
      background: white;
      padding: 18px 20px;
      border-radius: var(--r);
      border: 1px solid var(--border);
      box-shadow: 0 4px 16px rgba(0,0,0,.05);
      margin-top: 22px;
    }

    .pill {
      background: color-mix(in srgb, var(--brand-2) 30%, white);
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 700;
      margin-bottom: 6px;
      display: inline-block;
    }

    .order-status-body {
      display: flex;
      gap: 18px;
      margin-top: 14px;
      align-items: flex-start;
    }

    .order-cover-thumb img {
      max-width: 120px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,.15);
    }

    @media(max-width:640px){
      .order-status-body {
        flex-direction: column;
        align-items: center;
        text-align:center;
      }
    }
  </style>
</head>

<body data-theme="kids">

<header class="site-header" role="banner">
  <a href="/index.html" class="brand">
    <img src="images/pilot-logo.png" alt="SagoStugan">
    <span>SagoStugan</span>
  </a>
  <nav class="main-nav">
    <a href="/index.html">Hem</a>
    <a href="/index.html#bookForm">Skapa bok</a>
    <a href="/index.html#examples">Exempel</a>
    <a href="/index.html#about">Om oss</a>
    <a href="/status.html" class="active">Status</a>
  </nav>
  <button id="navToggle" class="hamburger" aria-expanded="false" aria-controls="mobileMenu">â˜°</button>
</header>

<div class="mobile-menu" id="mobileMenu" aria-hidden="true">
  <nav>
    <a href="/index.html">Hem</a>
    <a href="/index.html#bookForm">Skapa bok</a>
    <a href="/index.html#examples">Exempel</a>
    <a href="/index.html#about">Om oss</a>
    <a href="/status.html">Status</a>
  </nav>
</div>

<main class="container">
  <section class="status-panel">
    <h1>Orderstatus</h1>
    <p id="statusBar" class="muted">Ange ditt order-ID fÃ¶r att se status pÃ¥ din bok.</p>

    <form id="statusForm" class="form-card" style="margin-top:12px">
      <div class="form-row">
        <div class="field">
          <label for="orderIdInput">Order-ID</label>
          <input id="orderIdInput" placeholder="t.ex. 996a9557-..." />
          <p class="hint">Order-ID hittar du i bekrÃ¤ftelsemailet.</p>
        </div>
      </div>
      <div class="actions">
        <button type="submit" class="btn btn-primary">Visa status</button>
      </div>
    </form>

    <div id="orderBox" class="order-box hidden">
      <div class="order-status-header">
        <span class="pill" id="pillKind">â€”</span>
        <span>Order-ID: <strong id="orderId">â€”</strong></span><br>
        <span>Status: <strong id="orderState">â€”</strong></span><br>
        <small id="lastUpdated" class="muted">â€”</small>
      </div>

      <div class="order-status-body">
        <div class="order-cover-thumb">
          <img id="coverThumb" class="hidden" alt="Omslag" />
        </div>
        <div class="order-book-info">
          <h2 id="bookTitle" style="margin:0 0 6px;font-size:1.1rem;">â€”</h2>
          <p id="bookInfo" class="muted" style="margin:0 0 8px;font-size:0.9rem;">â€”</p>
          <div class="links" id="infoLinks"></div>
        </div>
      </div>
    </div>

    <div class="spinner-lg hidden" id="spinner"></div>
    <p id="err" class="muted hidden"></p>
  </section>
</main>

<footer class="site-footer">
  <p>Â© 2025 SagoStugan</p>
</footer>

<script>
/* Mobile menu */
(function(){
  const t=document.getElementById("navToggle");
  const m=document.getElementById("mobileMenu");
  if(!t||!m) return;
  const setOpen=o=>{
    t.setAttribute("aria-expanded",o);
    m.setAttribute("aria-hidden",!o);
    m.classList.toggle("open",o);
  };
  t.addEventListener("click",()=>setOpen(t.getAttribute("aria-expanded")!=="true"));
  m.addEventListener("click",e=>{ if(e.target.tagName==="A") setOpen(false); });
})();

/* Status Logic */
(function(){
  const BACKEND="https://bokpilot-backend.sebastian-runell.workers.dev";
  const $=id=>document.getElementById(id);
  const show=el=>el.classList.remove("hidden");
  const hide=el=>el.classList.add("hidden");
  const setText=(el,t)=>el.textContent=t;

  const el={
    form:$("statusForm"),
    input:$("orderIdInput"),
    box:$("orderBox"),
    pill:$("pillKind"),
    orderId:$("orderId"),
    orderState:$("orderState"),
    updated:$("lastUpdated"),
    bar:$("statusBar"),
    spinner:$("spinner"),
    err:$("err"),
    cover:$("coverThumb"),
    title:$("bookTitle"),
    info:$("bookInfo"),
    links:$("infoLinks")
  };

  async function fetchJSON(url){
    const r=await fetch(url);
    const ct=r.headers.get("content-type")||"";
    const isJSON=ct.includes("application/json");
    const body=isJSON?await r.json():await r.text();
    if(!r.ok || (isJSON && body.error)) throw new Error(body.error||`HTTP ${r.status}`);
    return body;
  }

   function explain(order){
    const kind = (order.kind || order.draft?.kind || "pdf").toLowerCase();
    const isPrinted = (kind === "printed" || kind === "print");

    el.links.innerHTML = isPrinted
      ? `<p class="muted">Tryckt bok â€“ vi uppdaterar status lÃ¶pande frÃ¥n tryckeriet, du fÃ¥r ett mail nÃ¤r boken Ã¤r pÃ¥ vÃ¤g!.</p>`
      : `<p class="muted">Digital bok â€“ du hittar PDF-filen i ditt kvitto-mail frÃ¥n SagoStugan.</p>`;
  }

  function render(order, id){
    show(el.box);
    setText(el.orderId, id);

    const raw =
      order.provider_status ||
      order.gelato_status ||
      order.status ||
      "okÃ¤nd";
    setText(el.orderState, raw);

    const kind = (order.kind || order.draft?.kind || "pdf").toLowerCase();
    const isPrinted = (kind === "printed" || kind === "print");
    setText(el.pill, isPrinted ? "Tryckt bok" : "Digital PDF");

    // ðŸ”¹ Titel: funkar nu Ã¤ven fÃ¶r digitala ordrar (draft.story.book.title)
    const title =
      order.book?.title ||
      order.story?.book?.title ||
      order.draft?.story?.book?.title ||
      "Din bok";
    setText(el.title, title);

    // ðŸ”¹ Sidantal: leta pÃ¥ samma stÃ¤llen
    const pages =
      order.book?.pages ??
      order.story?.book?.pages ??
      order.draft?.story?.book?.pages;
    const pageCount = Array.isArray(pages) ? pages.length : null;

    const txt = pageCount
      ? `${pageCount} sidor.`
      : "";
    setText(el.info, txt);

    // ðŸ”¹ Thumbnail â€“ vi anvÃ¤nder cover_thumb_url som du sÃ¤tter i backend
    const thumb =
      order.book?.cover_thumb_url ||
      order.cover_thumb_url ||
      null;

    if (thumb) {
      el.cover.src = thumb;
      show(el.cover);
    } else {
      el.cover.src = "";
      hide(el.cover);
    }

    explain(order);

    const now = new Date();
    setText(
      el.updated,
      `Senast uppdaterad: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`
    );
    setText(el.bar, "Status hÃ¤mtad. Uppdateras vid laddning av sidan.");
  }


  async function load(id){
    hide(el.err);
    show(el.spinner);
    try{
      const o = await fetchJSON(`${BACKEND}/api/orders/status?id=${encodeURIComponent(id)}`);
      render(o,id);
    }catch(e){
      setText(el.err, e.message || "Kunde inte hÃ¤mta order.");
      show(el.err);
      hide(el.box);
    }finally{
      hide(el.spinner);
    }
  }

  if(new URL(location.href).searchParams.get("id")){
    const id=new URL(location.href).searchParams.get("id");
    el.input.value=id;
    load(id);
  }

  el.form.addEventListener("submit",ev=>{
    ev.preventDefault();
    const id=el.input.value.trim();
    if(!id){ setText(el.err,"Ange ett order-ID."); show(el.err); return; }
    load(id);
    history.replaceState({}, "", `?id=${encodeURIComponent(id)}`);
  });

})();
</script>

</body>
</html>
