<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orderstatus ‚Äì SagoStugan</title>
  <link rel="icon" href="images/logo.png">
  <link rel="stylesheet" href="./style.css">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
 /* ========= Status / success-paneler ========= */

.muted {
  color: var(--muted);
}

/* Wrapper-panel runt inneh√•llet */
.status-panel {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  box-shadow: var(--shadow);
  padding: 32px 26px 40px;
  max-width: 820px;
  margin: 40px auto 48px;
  position: relative;
  overflow: hidden;
}

/* liten soft highlight h√∂gst upp */
.status-panel::before {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at top, rgba(255,255,255,0.4), transparent 60%);
  pointer-events: none;
  opacity: .7;
}

.status-panel h1 {
  font-size: 2rem;
  margin: 4px 0 6px;
  letter-spacing: .3px;
  text-align: center;
}

/* undertexten under rubriken */
#statusBar {
  text-align: center;
  max-width: 32rem;
  margin: 0 auto;
  font-size: .98rem;
}

/* centrera formul√§ret och knappen */
#statusForm {
  margin-top: 20px;
}

#statusForm .form-row {
  max-width: 520px;
  margin: 0 auto;
}

.status-panel .actions {
  justify-content: center;
  margin-top: 8px;
}

/* Liten ‚Äúhero‚Äù-sektion om du vill l√§gga till mer text senare */
.status-hero {
  text-align: center;
  margin: 20px 0 32px;
}

.status-hero h2 {
  font-size: 1.6rem;
  margin: 0;
}

.status-hero p {
  margin-top: 6px;
  font-size: 1rem;
  opacity: .85;
}

/* Spinner */
.spinner-lg {
  margin: 18px auto 0;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 4px solid rgba(0,0,0,.08);
  border-top-color: var(--brand);
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Box med orderinfo */
.order-box {
  background: white;
  padding: 18px 20px 20px;
  border-radius: var(--r);
  border: 1px solid var(--border);
  box-shadow: 0 4px 16px rgba(0,0,0,.05);
  margin-top: 26px;
}

.order-box strong {
  font-weight: 700;
}

.order-status-header {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 14px;
  align-items: center;
  margin-bottom: 10px;
}

/* Liten status-pill (t.ex. ‚ÄúDigital bok klar‚Äù) */
.pill {
  background: color-mix(in srgb, var(--brand-2) 35%, white);
  padding: 4px 12px;
  border-radius: 999px;
  font-size: 0.82rem;
  font-weight: 700;
  margin-right: 6px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.pill::before {
  content: "";
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: #2ecc71;
}

/* Layout f√∂r bild + text i order-status */
.order-status-body {
  display: flex;
  gap: 18px;
  margin-top: 8px;
  align-items: flex-start;
}

.order-cover-thumb img {
  max-width: 120px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,.15);
}

/* L√§nkar/knappar p√• status-sidor (t.ex. ‚Äú√ñppna PDF‚Äù) */
.links a {
  display: inline-flex;
  align-items: center;
  padding: 10px 16px;
  margin-top: 8px;
  border-radius: 999px;
  background: white;
  border: 1px solid var(--border);
  box-shadow: 0 4px 14px rgba(0,0,0,.04);
  font-size: .9rem;
  text-decoration: none;
  color: inherit;
}

.links a + a {
  margin-left: .5rem;
}

.links a:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 22px rgba(0,0,0,.08);
}

/* Sm√• inline-statusgrejer */
.status-inline {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

/* Rad med ‚Äúf√∂rs√∂k igen‚Äù-knapp + status */
.retry-row {
  margin-top: 12px;
  display: flex;
  gap: 8px;
  align-items: center;
}

/* Extra panel f√∂r t.ex. printformul√§r */
#printForm {
  background: color-mix(in srgb, var(--panel) 60%, white);
  padding: 28px;
  border-radius: var(--r-xl);
}

/* Felmeddelande */
#err {
  margin-top: 14px;
  text-align: center;
  font-size: .92rem;
}

/* Responsivitet f√∂r status-sidor */
@media (max-width: 640px) {
  .status-panel {
    padding: 24px 18px 32px;
    margin-top: 24px;
  }

  .order-box {
    padding: 16px;
  }

  #statusForm .form-row {
    max-width: 100%;
  }

  .links a {
    width: 100%;
    justify-content: center;
  }

  .status-hero h2 {
    font-size: 1.4rem;
  }

  #printForm {
    padding: 22px 18px;
  }

  .order-status-body {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .order-status-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
}
/* Centrera knapparna i statusformul√§ret */
.actions-status {
  justify-content: center;
  gap: 10px;
  margin-top: 12px;
}

@media (max-width: 640px) {
  .actions-status {
    flex-direction: column;
  }

  .actions-status .btn {
    width: 100%;
    justify-content: center;
  }
}


  </style>
</head>

<body data-theme="kids">
  <!-- Global Header -->
<header class="site-header" role="banner">
  <div class="header-inner">
    <a href="/index.html" class="brand" aria-label="SagoStugan startsida">
      <img src="images/logo.png" alt="SagoStugan" />
      <span>SagoStugan</span>
    </a>

    <nav class="main-nav" aria-label="Huvudmeny">
      <a href="/index.html" data-nav="home">Hem</a>
      <a href="#bookForm" data-nav="create">Skapa bok</a>
      <a href="#examples" data-nav="examples">Exempel</a>
      <a href="/status.html" data-nav="status">Orderstatus</a>
    </nav>
  </div>
</header>


<main class="container">
  <section class="status-panel">
    <h1>Orderstatus</h1>
    <p id="statusBar" class="muted">Ange ditt order-ID f√∂r att se status p√• din bok.</p>

   <form id="statusForm" class="form-card" style="margin-top:12px">
  <div class="form-row">
    <div class="field">
      <label for="orderIdInput">Order-ID</label>
      <input id="orderIdInput" placeholder="t.ex. 996a9557-..." />
      <p class="hint">Order-ID hittar du i bekr√§ftelsemailet.</p>
    </div>

    <div class="field">
      <label for="emailInput">Din e-post</label>
      <input id="emailInput" type="email" placeholder="t.ex. namn@exempel.se" />
      <p class="hint">Vi anv√§nder den bara f√∂r att skicka orderstatus.</p>
    </div>
  </div>

  <div class="actions actions-status">
    <button type="submit" class="btn btn-primary">Visa status</button>
    <button type="button" id="emailStatusBtn" class="btn btn-secondary">
      Skicka status till min e-post
    </button>
  </div>

  <p id="emailStatusMsg" class="muted" style="margin-top:8px;"></p>
</form>


    <div id="orderBox" class="order-box hidden">
      <div class="order-status-header">
        <span class="pill" id="pillKind">‚Äî</span>
        <span>Order-ID: <strong id="orderId">‚Äî</strong></span><br>
        <span>Status: <strong id="orderState">‚Äî</strong></span><br>
        <small id="lastUpdated" class="muted">‚Äî</small>
      </div>

      <div class="order-status-body">
        <div class="order-cover-thumb">
          <img id="coverThumb" class="hidden" alt="Omslag" />
        </div>
        <div class="order-book-info">
          <h2 id="bookTitle" style="margin:0 0 6px;font-size:1.1rem;">‚Äî</h2>
          <p id="bookInfo" class="muted" style="margin:0 0 8px;font-size:0.9rem;">‚Äî</p>
          <div class="links" id="infoLinks"></div>
        </div>
      </div>
    </div>

    <div class="spinner-lg hidden" id="spinner"></div>
    <p id="err" class="muted hidden"></p>
  </section>
</main>

<footer class="site-footer">
  <p>¬© 2025 SagoStugan</p>
</footer>

<script>
/* Mobile menu */
(function(){
  const t=document.getElementById("navToggle");
  const m=document.getElementById("mobileMenu");
  if(!t||!m) return;
  const setOpen=o=>{
    t.setAttribute("aria-expanded",o);
    m.setAttribute("aria-hidden",!o);
    m.classList.toggle("open",o);
  };
  t.addEventListener("click",()=>setOpen(t.getAttribute("aria-expanded")!=="true"));
  m.addEventListener("click",e=>{ if(e.target.tagName==="A") setOpen(false); });
})();

/* Status Logic */
(function(){
  const BACKEND="https://bokpilot-backend.sebastian-runell.workers.dev";
  const $=id=>document.getElementById(id);
  const show=el=>el.classList.remove("hidden");
  const hide=el=>el.classList.add("hidden");
  const setText=(el,t)=>el.textContent=t;
const el = {
  form: $("statusForm"),
  input: $("orderIdInput"),
  email: $("emailInput"),
  emailBtn: $("emailStatusBtn"),
  emailMsg: $("emailStatusMsg"),
  box: $("orderBox"),
  pill: $("pillKind"),
  orderId: $("orderId"),
  orderState: $("orderState"),
  updated: $("lastUpdated"),
  bar: $("statusBar"),
  spinner: $("spinner"),
  err: $("err"),
  cover: $("coverThumb"),
  title: $("bookTitle"),
  info: $("bookInfo"),
  links: $("infoLinks")
};


 async function fetchJSON(url, options){
  const r = await fetch(url, options || {});
  const ct = r.headers.get("content-type") || "";
  const isJSON = ct.includes("application/json");
  const body = isJSON ? await r.json() : await r.text();
  if (!r.ok || (isJSON && body.error)) {
    throw new Error(body.error || `HTTP ${r.status}`);
  }
  return body;
}


   function explain(order){
    const kind = (order.kind || order.draft?.kind || "pdf").toLowerCase();
    const isPrinted = (kind === "printed" || kind === "print");

    el.links.innerHTML = isPrinted
      ? `<p class="muted">Tryckt bok ‚Äì vi uppdaterar status l√∂pande fr√•n tryckeriet, du f√•r ett mail n√§r boken √§r p√• v√§g!.</p>`
      : `<p class="muted">Digital bok ‚Äì Kolla din mail fr√•n SagoStugan f√∂r att hitta till nedladdning av din digitala bok.</p>`;
  }

  function render(order, id){
    show(el.box);
    setText(el.orderId, id);

    const raw =
      order.provider_status ||
      order.gelato_status ||
      order.status ||
      "ok√§nd";
    setText(el.orderState, raw);

    const kind = (order.kind || order.draft?.kind || "pdf").toLowerCase();
    const isPrinted = (kind === "printed" || kind === "print");
    setText(el.pill, isPrinted ? "Tryckt bok" : "Digital PDF");

    // üîπ Titel: funkar nu √§ven f√∂r digitala ordrar (draft.story.book.title)
    const title =
      order.book?.title ||
      order.story?.book?.title ||
      order.draft?.story?.book?.title ||
      "Din bok";
    setText(el.title, title);

    // üîπ Sidantal: leta p√• samma st√§llen
    const pages =
      order.book?.pages ??
      order.story?.book?.pages ??
      order.draft?.story?.book?.pages;
    const pageCount = Array.isArray(pages) ? pages.length : null;

    const txt = pageCount
      ? `${pageCount} sidor.`
      : "";
    setText(el.info, txt);

    // üîπ Thumbnail ‚Äì vi anv√§nder cover_thumb_url som du s√§tter i backend
    const thumb =
      order.book?.cover_thumb_url ||
      order.cover_thumb_url ||
      null;

    if (thumb) {
      el.cover.src = thumb;
      show(el.cover);
    } else {
      el.cover.src = "";
      hide(el.cover);
    }

    explain(order);

    const now = new Date();
    setText(
      el.updated,
      `Senast uppdaterad: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`
    );
    setText(el.bar, "Status h√§mtad. Uppdateras vid laddning av sidan.");
  }


  async function load(id){
    hide(el.err);
    show(el.spinner);
    try{
      const o = await fetchJSON(`${BACKEND}/api/orders/status?id=${encodeURIComponent(id)}`);
      render(o,id);
    }catch(e){
      setText(el.err, e.message || "Kunde inte h√§mta order.");
      show(el.err);
      hide(el.box);
    }finally{
      hide(el.spinner);
    }
  }

  if(new URL(location.href).searchParams.get("id")){
    const id=new URL(location.href).searchParams.get("id");
    el.input.value=id;
    load(id);
  }

  el.form.addEventListener("submit",ev=>{
    ev.preventDefault();
    const id=el.input.value.trim();
    if(!id){ setText(el.err,"Ange ett order-ID."); show(el.err); return; }
    load(id);
    history.replaceState({}, "", `?id=${encodeURIComponent(id)}`);
  });

})();

async function sendEmailStatus() {
  hide(el.err);
  if (el.emailMsg) el.emailMsg.textContent = "";

  const id = el.input.value.trim();
  const email = (el.email.value || "").trim();

  if (!id) {
    setText(el.err, "Fyll i ditt order-ID f√∂rst.");
    show(el.err);
    return;
  }

  if (!email || !email.includes("@")) {
    setText(el.err, "Fyll i en giltig e-postadress.");
    show(el.err);
    return;
  }

  if (el.emailBtn) el.emailBtn.disabled = true;
  if (el.emailMsg) setText(el.emailMsg, "Skickar status till din e-post ‚Ä¶");

  try {
    await fetchJSON(`${BACKEND}/api/orders/status-email`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, email })
    });

    if (el.emailMsg) {
      setText(
        el.emailMsg,
        "Klart! Om uppgifterna st√§mmer kommer ett mail med orderstatus inom kort."
      );
    }
  } catch (e) {
    if (el.emailMsg) {
      setText(
        el.emailMsg,
        e.message || "Kunde inte skicka e-post just nu. Prova igen senare."
      );
    }
  } finally {
    if (el.emailBtn) el.emailBtn.disabled = false;
  }
}

</script>

</body>
</html>
