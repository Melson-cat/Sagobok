<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orderstatus – BokPiloten</title>
  <link rel="icon" href="images/pilot-logo.png">
  <link rel="stylesheet" href="./style.css">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body data-theme="kids">
  <!-- Global Header -->
  <header class="site-header" role="banner">
    <a href="/index.html" class="brand" aria-label="BokPiloten startsida">
      <img src="images/pilot-logo.png" alt="BokPiloten" />
      <span>BokPiloten</span>
    </a>
    <nav class="main-nav" aria-label="Huvudmeny">
      <a href="/index.html" data-nav="home">Hem</a>
      <a href="/index.html#bookForm" data-nav="create">Skapa bok</a>
      <a href="/index.html#examples" data-nav="examples">Exempel</a>
      <a href="/index.html#about" data-nav="about">Om oss</a>
      <a href="/status.html" data-nav="status">Status</a>
    </nav>
    <button id="navToggle" class="hamburger" aria-label="Meny" aria-expanded="false" aria-controls="mobileMenu">☰</button>
  </header>
  <div class="mobile-menu" id="mobileMenu" aria-hidden="true">
    <nav>
      <a href="/index.html">Hem</a>
      <a href="/index.html#bookForm">Skapa bok</a>
      <a href="/index.html#examples">Exempel</a>
      <a href="/index.html#about">Om oss</a>
      <a href="/status.html">Status</a>
    </nav>
  </div>

  <main class="container">
    <section class="panel" aria-labelledby="statusTitle">
      <h1 id="statusTitle" style="margin:0 0 8px">Orderstatus</h1>
      <div id="statusBar" class="status-bar" aria-live="polite">Ange order-id eller session-id för att visa status.</div>

      <form id="statusForm" class="form-card" style="margin-top:12px">
        <div class="form-row">
          <div class="field">
            <label for="orderIdInput">Order-ID</label>
            <input id="orderIdInput" placeholder="t.ex. 996a9557-...." />
            <p class="hint">Om du har ett order-id kan du använda det direkt.</p>
          </div>
          <div class="field">
            <label for="sessionIdInput">Stripe Session-ID</label>
            <input id="sessionIdInput" placeholder="cs_test_..." />
            <p class="hint">Alternativt: ange checkout session-id så slår vi upp din order.</p>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="btn btn-primary">Visa status</button>
          <button id="pollBtn" type="button" class="btn btn-secondary">Starta auto-uppdatering</button>
        </div>
      </form>

      <div id="orderBox" class="box hidden" style="margin-top:12px">
        <div class="stack">
          <span class="pill" id="pillKind">—</span>
          <span>Order-ID: <strong id="orderId">—</strong></span>
          <span>Status: <strong id="orderState">—</strong></span>
        </div>
        <div class="links" id="downloadLinks"></div>
      </div>

      <div class="spinner-lg hidden" id="spinner" aria-hidden="true"></div>
      <p id="err" class="muted hidden"></p>
    </section>
  </main>

  <footer class="site-footer" role="contentinfo">
    <p>© 2025 BokPiloten</p>
  </footer>

  <script>
  // Header controller (delad)
  (function () {
    const toggle = document.getElementById("navToggle");
    const menu = document.getElementById("mobileMenu");
    if (toggle && menu) {
      const setOpen = (open) => {
        toggle.setAttribute("aria-expanded", String(open));
        menu.setAttribute("aria-hidden", String(!open));
        menu.classList.toggle("open", open);
      };
      setOpen(false);
      toggle.addEventListener("click", () => {
        const isOpen = toggle.getAttribute("aria-expanded") === "true";
        setOpen(!isOpen);
      });
      menu.addEventListener("click", (e) => {
        if (e.target && e.target.tagName === "A") setOpen(false);
      });
    }
  })();
  </script>

  <script>
  (function () {
    const BACKEND = "https://bokpilot-backend.sebastian-runell.workers.dev";
    const $ = (id) => document.getElementById(id);
    const show = (el) => el && el.classList.remove("hidden");
    const hide = (el) => el && el.classList.add("hidden");
    const setText = (el, v) => { if (el) el.textContent = v ?? ""; };

    const el = {
      form: $("statusForm"),
      orderInput: $("orderIdInput"),
      sessionInput: $("sessionIdInput"),
      pollBtn: $("pollBtn"),
      bar: $("statusBar"),
      box: $("orderBox"),
      pillKind: $("pillKind"),
      orderId: $("orderId"),
      orderState: $("orderState"),
      links: $("downloadLinks"),
      spinner: $("spinner"),
      err: $("err"),
    };

    async function fetchJSON(url) {
      const r = await fetch(url);
      const ct = r.headers.get("content-type") || "";
      const isJSON = ct.includes("application/json");
      const body = isJSON ? await r.json() : await r.text();
      if (!r.ok || (isJSON && body && body.error)) {
        const msg = (isJSON && body && body.error) || `HTTP ${r.status}`;
        throw new Error(msg);
      }
      return isJSON ? body : { text: body };
    }

    const getOrder     = (id)  => fetchJSON(`${BACKEND}/api/orders/status?id=${encodeURIComponent(id)}`);
    const getOrderId   = (sid) => fetchJSON(`${BACKEND}/api/checkout/order-id?session_id=${encodeURIComponent(sid)}`).then(j => j.order_id || null);

    function renderFiles(files) {
      el.links.innerHTML = "";
      if (files?.interior_url) {
        const a = document.createElement("a");
        a.className = "btn";
        a.href = files.interior_url;
        a.target = "_blank"; a.rel="noopener";
        a.textContent = "Ladda ner inlagan (PDF)";
        el.links.appendChild(a);
      }
      if (files?.cover_url) {
        const a = document.createElement("a");
        a.className = "btn";
        a.href = files.cover_url;
        a.target = "_blank"; a.rel="noopener";
        a.textContent = "Ladda ner omslaget (PDF)";
        el.links.appendChild(a);
      }
    }

    function setBar(msg) { setText(el.bar, msg); }
    function showErr(msg) { setText(el.err, msg); show(el.err); }
    function clearErr() { setText(el.err, ""); hide(el.err); }

    async function resolveOrderId() {
      const url = new URL(location.href);
      const q = url.searchParams;
      const id = q.get("id");
      const sid = q.get("session_id");
      if (id) return id;
      if (sid) return await getOrderId(sid);
      return null;
    }

    async function loadStatus(orderId) {
      clearErr();
      show(el.spinner);
      try {
        const o = await getOrder(orderId);
        show(el.box);
        setText(el.orderId, orderId);
        setText(el.orderState, o?.status || "okänd");
        setText(el.pillKind, (o?.kind || o?.draft?.kind || "pdf") === "printed" ? "Tryckt bok" : "Digital PDF");
        renderFiles(o.files || {});
        setBar(`Senast uppdaterad: ${new Date().toLocaleString()}`);
      } catch (e) {
        showErr(e?.message || "Kunde inte hämta order.");
      } finally {
        hide(el.spinner);
      }
    }

    let pollTimer = null;
    function startPolling(orderId, ms=3000) {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(() => loadStatus(orderId), ms);
      setBar(`Auto-uppdatering var ${ms/1000}s – pågår…`);
    }

    // Init
    el.form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const id = el.orderInput.value.trim();
      const sid = el.sessionInput.value.trim();
      try {
        const orderId = id || (sid ? await getOrderId(sid) : null);
        if (!orderId) throw new Error("Ange order-id eller session-id.");
        await loadStatus(orderId);
        history.replaceState({}, "", `?id=${encodeURIComponent(orderId)}`);
      } catch (e) {
        showErr(e?.message || "Felaktiga uppgifter.");
      }
    });

    el.pollBtn.addEventListener("click", async () => {
      const idInUrl = new URL(location.href).searchParams.get("id");
      let orderId = (el.orderInput.value.trim() || idInUrl);
      if (!orderId && el.sessionInput.value.trim()) {
        orderId = await getOrderId(el.sessionInput.value.trim());
      }
      if (!orderId) return showErr("Ange order-id eller session-id innan auto-uppdatering.");
      await loadStatus(orderId);
      startPolling(orderId);
    });

    // Auto-ladda om ?id= eller ?session_id= finns
    (async () => {
      const orderId = await resolveOrderId();
      if (orderId) {
        await loadStatus(orderId);
      }
    })();
  })();
  </script>
</body>
</html>
